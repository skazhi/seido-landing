# Логика анонсов забегов — автоматический сбор, фильтры, карта

**Дата:** 21 февраля 2026 г.  
**Цель:** Продумать автоматический сбор анонсов по России на 2026 год: города, даты, тип, популярность, карта.

---

## 1. Требуемые фильтры и данные

| Фильтр | Поле в БД | Источник данных | Автоматизация |
|--------|-----------|-----------------|---------------|
| **Город** | `location`, `city` | Парсер, из названия/места | ✅ Парсеры дают |
| **Дата** | `date` | Парсер | ✅ |
| **Тип** | `race_type` | Парсер, ключевые слова | ⚠️ Частично (см. ниже) |
| **Популярность** | `popularity_score` | Расчёт из наших данных | ✅ Вычисляемо |
| **Карта** | `lat`, `lon` | Геокодирование | ⚠️ Через API или справочник |

---

## 2. Типы забегов (race_type)

Единый справочник для фильтрации:

| Тип | Ключевые слова в названии/описании | Примеры |
|-----|-----------------------------------|---------|
| **шоссе** | марафон, полумарафон, 10 км, 5 км, дорога, городской | Московский марафон |
| **трейл** | трейл, trail, трейлраннинг | Горный трейл |
| **кросс** | кросс, cross | Кросс Нации |
| **горный** | горный, mountain, skyrace | Skyrunning |
| **стадион** | стадион, indoor | Зимний стадион |
| **ночной** | ночной, night run | Ночная десятка |
| **ультра** | ультра, ultra, 50 км+ | Ультра-трейл |
| **триатлон** | триатлон, triathlon | IronStar |
| **снежный/зимний** | зимний, snow, ice | Ледовый марафон |

**Автоматика:** Определять `race_type` по ключевым словам в названии забега. Фолбек: `шоссе`.

---

## 3. Популярность — как считать

### Варианты (от простого к сложному)

| Метод | Описание | Реализуемость |
|-------|----------|---------------|
| **A. Количество результатов** | `popularity_score = COUNT(results) WHERE race_id` | ✅ Уже есть данные |
| **B. Количество участников в протоколе** | `total_runners` из протокола | ✅ При парсинге результатов |
| **C. Исторический рейтинг** | У прошлых лет того же забега — среднее | ✅ После накопления данных |
| **D. Внешние метрики** | Участников на сайте организатора | ⚠️ Нужен парсинг страницы забега |
| **E. Ручная отметка** | «Рекомендуем», «Топ» — от админа | ✅ Просто |

### Рекомендация

- **Старт:** Метод A — количество результатов в нашей БД. Забеги с результатами = популярные.
- **Дальше:** Метод B — при парсинге протоколов сохранять `total_runners`.
- **Поле:** `popularity_score INTEGER` — можно хранить число участников или свой рейтинг.

---

## 4. Карта — координаты

### Откуда брать lat/lon

| Источник | Как | Точность |
|----------|-----|----------|
| **Яндекс Геокодер** | API по адресу/городу | Высокая |
| **OpenStreetMap Nominatim** | Бесплатный API | Средняя |
| **Справочник городов** | JSON с координатами крупных городов РФ | Быстро, по городу |
| **Данные организатора** | Если на сайте есть карта/координаты | Лучшая точность |
| **Фолбек** | Координаты центра города | Базовая |

### Рекомендация

1. Справочник городов РФ (≈500 городов) — для `location` без парсинга карт.
2. При наличии адреса — геокодер (Яндекс или Nominatim).
3. В БД добавить поля: `lat REAL`, `lon REAL`.

---

## 5. Источники анонсов — что автоматизировать

### Уже есть / в работе (парсеры)

| Источник | Данные | Статус |
|----------|--------|--------|
| **RussiaRunning** | API | ✅ |
| **IronStar** | iron-star.com/event/ | ✅ |
| **Юнистар (RunC)** | runc.run | ✅ |
| **TIMERMAN** | kazan.run, timerman.org | ✅ |
| **RHR** | goldenultra.ru | ✅ |
| **Wild Trail** | wildtrail.ru | ✅ |
| **Open Band** | openband.run | ✅ |
| **Dream Trail** | dtrail.ru | ✅ |
| **TulaMarathon** | tulamarathon.org | ✅ |
| **Высшая лига** | events.topliga.ru | ✅ |

### Пропускаем на данном этапе

| Источник | Причина |
|----------|---------|
| **5верст** | Еженедельные субботние старты, мало интересны |
| **S95** | То же |

### Пока без парсера

| Источник | Примечание |
|----------|------------|
| **reg.o-time.ru** | Агрегатор, SPA |
| **Orgeo** | Платформа результатов, не календарь |

### Ограничения

- **ProBeg, Get.run** — агрегаторы. ToS нужно проверить; предпочтительно — парсить сайты организаторов.
- **RussiaRunning** — API, но нет `race_type`; определять по названию.

---

## 6. Парсеры (текущий статус)

| # | Источник | Статус |
|---|----------|--------|
| 1 | RussiaRunning | ✅ Работает |
| 2 | IronStar | ✅ Работает (iron-star.com/event/) |
| 3 | Юнистар (RunC) | ✅ Работает (стат. список 2026) |
| 4 | TIMERMAN | ✅ Работает (Казанский марафон + timerman.org) |
| 5 | RHR | ✅ goldenultra.ru |
| 6 | Wild Trail | ✅ wildtrail.ru |
| 7 | Open Band | ✅ openband.run |
| 8 | Dream Trail | ✅ dtrail.ru |
| 9 | TulaMarathon | ✅ tulamarathon.org |
| 10 | Высшая лига | ✅ events.topliga.ru |
| — | 5верст, S95 | ⏭️ Пропущены |
| — | reg.o-time.ru | ⏭️ SPA |

---

## 7. Изменения в схеме БД

```sql
-- Добавить в таблицу races:
ALTER TABLE races ADD COLUMN city TEXT;           -- Нормализованный город для фильтра
ALTER TABLE races ADD COLUMN lat REAL;            -- Широта
ALTER TABLE races ADD COLUMN lon REAL;            -- Долгота
ALTER TABLE races ADD COLUMN popularity_score INTEGER DEFAULT 0;  -- Рейтинг популярности
ALTER TABLE races ADD COLUMN country TEXT DEFAULT 'Россия';

CREATE INDEX IF NOT EXISTS idx_races_city ON races(city);
CREATE INDEX IF NOT EXISTS idx_races_race_type ON races(race_type);
CREATE INDEX IF NOT EXISTS idx_races_popularity ON races(popularity_score DESC);
```

---

## 8. Логика фильтрации (API/бот/сайт)

### Псевдокод

```
GET /races?
  city=Москва          # точное совпадение или LIKE
  date_from=2026-01-01
  date_to=2026-12-31
  race_type=трейл      # шоссе, трейл, кросс...
  sort=popularity      # popularity | date | name
  limit=20
  offset=0
```

### По карте

- Фильтр по bounding box: `lat_min`, `lat_max`, `lon_min`, `lon_max`.
- Или радиус: «забеги в радиусе 50 км от точки».

---

## 9. Определение race_type по названию

```python
RACE_TYPE_KEYWORDS = {
    'трейл': ['трейл', 'trail', 'трейлраннинг', 'trailrunning'],
    'кросс': ['кросс', 'cross'],
    'горный': ['горный', 'mountain', 'skyrace', 'skyrunning'],
    'ультра': ['ультра', 'ultra', '50 км', '100 км'],
    'триатлон': ['триатлон', 'triathlon'],
    'ночной': ['ночной', 'night run', 'ночная'],
    'зимний': ['зимний', 'снежный', 'ледовый', 'ice', 'snow'],
    'стадион': ['стадион', 'indoor'],
}

def detect_race_type(name: str) -> str:
    name_lower = name.lower()
    for race_type, keywords in RACE_TYPE_KEYWORDS.items():
        if any(kw in name_lower for kw in keywords):
            return race_type
    return 'шоссе'
```

---

## 10. Геокодирование городов РФ

Минимальный справочник (JSON) — ~50–100 крупных городов:

```json
{
  "Москва": {"lat": 55.7558, "lon": 37.6173},
  "Санкт-Петербург": {"lat": 59.9343, "lon": 30.3351},
  "Казань": {"lat": 55.7887, "lon": 49.1221},
  ...
}
```

Для `location = "Москва"` или `"Москва, Парк Горького"` — брать город, подставлять координаты. При необходимости — Яндекс/OSM для уточнения.

---

## 11. Дубликаты

Один забег может быть у нескольких источников (RussiaRunning, ProBeg). Дедупликация:

- По `(name, date, location)` — считать дубликатом.
- При совпадении — оставлять запись с более полными данными.
- В БД можно добавить `source` и `external_id` для связи с источником.

---

## 12. Чеклист внедрения

- [ ] Миграция БД: `city`, `lat`, `lon`, `popularity_score`
- [ ] Функция `detect_race_type(name)` в парсерах
- [ ] Справочник городов РФ (JSON) для геокодинга
- [ ] Обновить RussiaRunning: извлекать `city` из API, добавлять `race_type`
- [ ] Починить/добавить парсеры: 5верст, S95, runc.run, TIMERMAN
- [ ] Расчёт `popularity_score` при добавлении результатов
- [ ] API/бот: фильтры city, date, race_type, sort=popularity
- [ ] Карта: эндпоинт для выборки по bbox или радиусу

---

*Документ — ориентир. Реализацию делать поэтапно.*

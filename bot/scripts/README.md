# Парсер протоколов забегов

Набор скриптов для парсинга протоколов забегов из PDF и Excel файлов и импорта результатов в базу данных.

## Структура

- `normalize_data.py` - Нормализация данных (ФИО, время, место, дата рождения)
- `pdf_parser.py` - Парсинг PDF протоколов
- `excel_parser.py` - Парсинг Excel протоколов
- `parse_protocol.py` - Основной импортер протоколов в БД

## Установка зависимостей

```bash
cd bot
pip install -r requirements.txt
```

## Использование

### Пример 1: Импорт PDF протокола

```python
import asyncio
from bot.scripts.parse_protocol import ProtocolImporter
from bot.db import db

async def main():
    await db.connect()
    
    importer = ProtocolImporter()
    
    await importer.import_protocol(
        file_path="protocols/pjaterka_2026.pdf",
        race_name="Пятерка в Парке",
        race_date="2026-03-01",
        race_location="Москва, Парк Горького",
        race_organizer="5верст",
        race_type="шоссе",
        distance="5 км",
        header_row=0  # Номер строки с заголовками
    )
    
    await db.disconnect()

asyncio.run(main())
```

### Пример 2: Импорт Excel протокола

```python
await importer.import_protocol(
    file_path="protocols/marathon_2026.xlsx",
    race_name="Московский марафон",
    race_date="2026-04-15",
    race_location="Москва, Лужники",
    race_organizer="Московский марафон",
    race_type="шоссе",
    distance="42.2 км",
    sheet_name="Протокол",  # Название листа
    header_row=0
)
```

## Поддерживаемые форматы протоколов

### PDF
- Таблицы, извлечённые через pdfplumber
- Автоматическое определение заголовков
- Поддержка многостраничных протоколов

### Excel
- Форматы .xlsx и .xls
- Автоматический выбор листа (поиск по ключевым словам)
- Поддержка нескольких листов

## Нормализация данных

Парсер автоматически нормализует:
- **ФИО**: "Иванов Иван Иванович" → first_name, last_name, middle_name
- **Время**: "15:30", "1:15:30" → секунды
- **Место**: "1", "1-е", "1 место" → число
- **Дата рождения**: "1990", "1990-05-15" → YYYY-MM-DD
- **Дистанция**: "5 км", "5000 м" → "5 км"
- **Пол**: "М", "Мужской" → "M" или "F"

## Структура протокола

Протокол должен содержать колонки:
- ФИО / Имя / Участник
- Время / Финиш
- Место
- (опционально) Год рождения
- (опционально) Город
- (опционально) Пол
- (опционально) Клуб

## Обработка ошибок

Парсер пропускает:
- Пустые строки
- Строки без ФИО
- Некорректные данные (логирует ошибки)

## Статистика

После импорта выводится статистика:
- Количество созданных забегов
- Количество созданных/найденных бегунов
- Количество добавленных результатов
- Количество ошибок
